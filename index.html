<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Τσιντσιλά</title>
    <style>
        html, body {
            font-size: 16px;
            font-family: "Open Sans", Calibri, "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        img {
            width: 100%;
            max-width: 250px;
            height: auto;
            float: right;
            margin-left: 8px;
        }
        p {
            font-size: 1.25rem;
        }
        span {
            /* https://www.cssportal.com/css-cubic-bezier-generator/ */
            transition: background 100ms ease-in;
        }
        audio {
            width: 100%;
        }
        main {
            max-width: 680px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
    <!--
        TODO: Organize and document links.
        https://manual.audacityteam.org/man/label_sounds.html
        Audacity -> Analyze -> Label Sounds... -> Minimum silence duration 100 ms
        http://magcius.github.io/audaciter/ - Convert Audacity labels.txt format to SRT files
        https://www.happyscribe.com/subtitle-tools/convert-srt-to-vtt - Convert SRT to VTT
        https://github.com/Pawper/HTML-Audio-Video-MDN/blob/master/index.html
        https://www.w3.org/wiki/VTT_Concepts
        https://www.greek-language.gr/certification/dbs/teachers/show.html?id=101
        https://commons.wikimedia.org/wiki/File:Chinchilla_lanigera_(Wroclaw_zoo)-2.JPG
    -->
</head>
<body>
    <main id="root"></main>
</body>
<script type="module">
    import vttParser from './vttParser.js';

    fetch(`Τσιντσιλά.vtt`)
        .then(r => r.text())
        .then(vttParser)
        .then(r => r.entries)
        .then(entries => {
            const audio = document.createElement('audio');
            audio.src = 'Τσιντσιλά.mp3';
            audio.innerHTML = 'Your browser does not support the <code>audio</code> element.';
            audio.controls = true;
            const root = document.getElementById('root');
            const heading = entries[0];
            const h1 = document.createElement('h1');
            let span = document.createElement('span');
            span.innerText = heading.text;
            span.id = 'Τσιντσιλά-' + heading.id;
            span.onclick = () => {
                audio.currentTime = heading.from / 1000;
            };
            h1.appendChild(span);
            root.appendChild(h1);
            const img = document.createElement('img');
            img.src = 'Τσιντσιλά.jpg';
            img.alt = 'Τσιντσιλά';
            root.appendChild(img);
            const paragraph = document.createElement('p')

            const paragraphEntries = entries.slice(1);
            paragraphEntries.forEach(entry => {
                span = document.createElement('span');
                span.innerText = entry.text;
                span.id = 'Τσιντσιλά-' + entry.id;
                span.onclick = () => {
                    audio.currentTime = entry.from / 1000;
                };
                paragraph.appendChild(span);
                paragraph.appendChild(document.createTextNode(' '));
            });
            root.appendChild(paragraph);

            root.appendChild(audio);
            return [entries, audio];
        })
        .then(([entries, audioElement]) => {
            let prevEl = null;
            audioElement.addEventListener('timeupdate', e => {
                let didSet = false;
                entries.forEach(element => {
                    const currentTimeInMs = audioElement.currentTime * 1000;
                    if (currentTimeInMs >= element.from && currentTimeInMs <= element.to) {
                        const el = document.getElementById('Τσιντσιλά-' + element.id);
                        if (prevEl !== null && prevEl !== el) {
                            prevEl.style.background = 'initial';
                        }
                        el.style.background = 'yellow';
                        prevEl = el;
                        didSet = true;
                    }
                });
                if (!didSet && prevEl !== null) {
                    prevEl.style.background = 'initial';
                }
                didSet = false;
            });
       });
</script>
</html>